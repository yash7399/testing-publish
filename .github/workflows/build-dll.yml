name: Build ASP.NET DLLs

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Restore NuGet packages
        run: nuget restore CommonExtranet.sln

      # ðŸ§± Step 1: Precompile ASP.NET website
      - name: Precompile ASP.NET website (with WebPages reference)
        shell: pwsh
        run: |
          Write-Host "ðŸ”¹ Starting ASP.NET precompilation..."
          $outDir = "precompiled"
          if (Test-Path $outDir) { Remove-Item -Recurse -Force $outDir }

          $compiler = "C:\Windows\Microsoft.NET\Framework\v4.0.30319\aspnet_compiler.exe"

          # Explicit references to avoid 'WebPages' and 'Razor' errors
          $webpagesDll = "C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Web.WebPages\v4.0_3.0.0.0__31bf3856ad364e35\System.Web.WebPages.dll"
          $mvcDll = "C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Web.Mvc\v4.0_5.2.0.0__31bf3856ad364e35\System.Web.Mvc.dll"
          $razorDll = "C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Web.Razor\v4.0_3.0.0.0__31bf3856ad364e35\System.Web.Razor.dll"

          $args = @(
            "-v", "/",
            "-p", "SMSInterface",
            "precompiled",
            "/reference:$webpagesDll",
            "/reference:$mvcDll",
            "/reference:$razorDll",
            "-errorstack",
            "-fixednames",
            "-nologo"
          )

          Write-Host "Running: $compiler $($args -join ' ')"
          & $compiler @args 2>&1 | Tee-Object -FilePath "precompile.log"

          Write-Host "===== Compiler Log Start ====="
          Get-Content precompile.log
          Write-Host "===== Compiler Log End ====="

      # ðŸ§± Step 2: Build the project (to ensure .cs files compile to DLLs)
      - name: Build website.publishproj
        run: msbuild SMSInterface/website.publishproj /p:Configuration=Release /p:VisualStudioVersion=12.0

      # ðŸ§± Step 3: Gather all DLLs
      - name: Collect all DLLs
        shell: pwsh
        run: |
          Write-Host "ðŸ”¹ Collecting DLLs..."
          $allDlls = "all-dlls"
          if (Test-Path $allDlls) { Remove-Item -Recurse -Force $allDlls }
          New-Item -ItemType Directory -Path $allDlls | Out-Null

          if (Test-Path "SMSInterface\Bin") {
            Copy-Item "SMSInterface\Bin\*.dll" $allDlls -ErrorAction SilentlyContinue
          }

          if (Test-Path "precompiled\Bin") {
            Copy-Item "precompiled\Bin\*.dll" $allDlls -ErrorAction SilentlyContinue
          }

          Write-Host "âœ… DLLs collected in: $allDlls"
          Get-ChildItem $allDlls

      # ðŸ§± Step 4: Upload DLLs as artifact
      - name: Upload DLL artifact
        uses: actions/upload-artifact@v4
        with:
          name: compiled-dlls
          path: all-dlls/
