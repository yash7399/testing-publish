name: Build 12 DLLs and Commit

on:
  workflow_dispatch:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild (VS 2019)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: '[16.0,17.0)'

      - name: Create output folder
        run: mkdir SMSInterface\dlls

      - name: Build solution
        run: msbuild CommonExtranet.sln /p:Configuration=Release /p:TargetFrameworkVersion=v4.5.1

      - name: Compile each .cs file into separate DLL
        shell: pwsh
        run: |
          $srcPath = "SMSInterface\\App_Code"
          $outPath = "SMSInterface\\dlls"
          $refs = @(
            "System.dll",
            "System.Web.dll",
            "System.Configuration.dll",
            "Microsoft.VisualBasic.dll"
          ) -join ","
          Get-ChildItem $srcPath -Filter "*.cs" | ForEach-Object {
            $name = [IO.Path]::GetFileNameWithoutExtension($_.Name)
            Write-Host "Compiling $name.dll"
            csc /target:library /out:"$outPath\\$name.dll" /reference:$refs "$($_.FullName)"
          }

      - name: Create new branch for DLLs
        shell: bash
        run: |
          branch="dll-build-$(date +'%Y%m%d-%H%M')"
          git checkout -b "$branch"
          git add SMSInterface/dlls/*.dll
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git commit -m "Add compiled DLLs"
          git push origin "$branch"
