name: Build and Publish DLLs

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install .NET Framework 4.5.1 targeting pack
        run: |
          choco install netfx-4.5.1-devpack -y

      - name: Setup MSBuild (VS 2022)
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: 17.0
          msbuild-architecture: x86

      - name: Verify MSBuild path
        run: where msbuild

      - name: Create output folder
        run: mkdir SMSInterface\dlls

      - name: Build solution (without publish profile)
        run: |
          msbuild CommonExtranet.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployOnBuild=false /p:PublishProfile=""

      - name: Compile each .cs file into separate DLL
        run: |
          cd SMSInterface\App_Code
          for %%f in (*.cs) do (
            echo Compiling %%f ...
            csc /target:library /out:"..\dlls\%%~nf.dll" %%f /reference:"System.dll;System.Web.dll;System.Configuration.dll;Microsoft.VisualBasic.dll"
          )

      - name: Create new branch for DLLs
        run: |
          git config user.email "actions@github.com"
          git config user.name "github-actions"
          git checkout -b dll-build-${{ github.run_number }}
          git add SMSInterface/dlls
          git commit -m "Add compiled DLLs"
          git push origin dll-build-${{ github.run_number }}
