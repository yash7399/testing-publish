name: Build and Generate DLLs (Self-Hosted)

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build and Generate DLLs
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        shell: powershell
        run: |
          Write-Host 'Setting up MSBuild...'
          $env:Path += ';C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin'

      - name: Create clean dll folder
        shell: powershell
        run: |
          Write-Host 'Cleaning old dll folder...'
          if (Test-Path dll) { Remove-Item -Recurse -Force dll }
          New-Item -ItemType Directory -Path dll | Out-Null
          Write-Host 'dll folder created.'

      - name: Build solution and generate base DLLs
        shell: powershell
        run: |
          Write-Host 'Starting MSBuild...'
          & 'C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe' 'C:\Users\yashh\Desktop\testing-publish\CommonExtranet.sln' /p:Configuration=Release /p:OutputPath=dll /p:Platform='Any CPU'
          Write-Host 'Build completed successfully.'

      - name: Generate DLLs for individual .cs files
        shell: powershell
        run: |
          Write-Host "Creating individual DLLs for each .cs file..."
          $csFiles = Get-ChildItem -Path . -Recurse -Include *.cs
          foreach ($file in $csFiles) {
            $dllName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name) + ".dll"
            $outputPath = Join-Path (Resolve-Path dll) $dllName
            Write-Host ("ðŸ”¹ Compiling " + $file.FullName + " â†’ " + $dllName)
            & "C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe" /target:library /out:$outputPath $file.FullName
          }
          Write-Host "All .cs files compiled to DLLs."

      - name: Verify generated DLLs
        shell: powershell
        run: |
          Write-Host 'DLL files generated:'
          Get-ChildItem -Path dll -Recurse -Include *.dll | ForEach-Object { Write-Host $_.FullName }

      - name: Push DLLs to dll-artifacts branch
        shell: powershell
        run: |
          Write-Host ' Pushing DLLs to dll-artifacts branch...'
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B dll-artifacts
          git add dll
          git commit -m "Add generated DLLs"
          git push -f origin dll-artifacts
          Write-Host 'DLLs pushed to dll-artifacts branch.'

      - name: Upload DLL artifacts (optional backup)
        uses: actions/upload-artifact@v4
        with:
          name: compiled-dlls
          path: dll/
