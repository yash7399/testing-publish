name: Build and Commit DLLs (C# Compiler)

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET Framework Compiler
        shell: pwsh
        run: |
          $sdk = "C:\\Windows\\Microsoft.NET\\Framework\\v4.0.30319"
          echo "CSC_PATH=$sdk\\csc.exe" >> $env:GITHUB_ENV

      - name: Build all .cs files into DLLs
        shell: pwsh
        run: |
          $dllFolder = "SMSInterface\\dlls"
          if (!(Test-Path $dllFolder)) { New-Item -ItemType Directory -Path $dllFolder | Out-Null }

          $csFiles = Get-ChildItem -Path "SMSInterface" -Filter "*.cs"
          foreach ($file in $csFiles) {
              $dllName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name) + ".dll"
              & $env:CSC_PATH /target:library /out:"$dllFolder\\$dllName" "$($file.FullName)"
          }

          Write-Host "âœ… DLLs generated in $dllFolder"

      - name: Verify generated DLLs
        shell: pwsh
        run: |
          Write-Host "Generated DLLs:"
          Get-ChildItem "SMSInterface\\dlls\\*.dll"

      - name: Commit DLLs to new branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          timestamp=$(date +"%Y%m%d-%H%M%S")
          branch="dll-build-$timestamp"
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -b "$branch"
          git add SMSInterface/dlls
          git commit -m "Add compiled DLLs - $timestamp"
          git push origin "$branch"
