name: Build and Generate DLLs (Self-Hosted)

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    name: Build and Generate DLLs
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup MSBuild
        shell: powershell
        run: |
          Write-Host '‚úÖ Setting up MSBuild...'
          $env:Path += ';C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin'

      - name: Create clean dll folder
        shell: powershell
        run: |
          Write-Host 'üßπ Cleaning old dll folder...'
          if (Test-Path dll) { Remove-Item -Recurse -Force dll }
          New-Item -ItemType Directory -Path dll | Out-Null
          Write-Host '‚úÖ dll folder created.'

      - name: Build solution and generate base DLLs
        shell: powershell
        run: |
          Write-Host 'üõ†Ô∏è  Starting MSBuild...'
          & 'C:\Program Files\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MSBuild.exe' 'D:\path\to\CommonExtranet.sln' /p:Configuration=Release /p:OutputPath=dll /p:Platform='Any CPU'
          Write-Host '‚úÖ Build completed successfully.'

      - name: Generate DLLs for individual .cs files
        shell: powershell
        run: |
          Write-Host '‚öôÔ∏è Creating individual DLLs for each .cs file...'
          $csFiles = Get-ChildItem -Path . -Recurse -Include *.cs
          foreach ($file in $csFiles) {
            $dllName = [System.IO.Path]::GetFileNameWithoutExtension($file.Name) + '.dll'
            $outputPath = Join-Path (Resolve-Path dll) $dllName
            Write-Host "üîπ Compiling $($file.FullName) ‚Üí $dllName"
            & 'C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe' /target:library /out:$outputPath $file.FullName
          }
          Write-Host '‚úÖ All .cs files compiled to DLLs.'

      - name: Verify generated DLLs
        shell: powershell
        run: |
          Write-Host 'üìÇ DLL files generated:'
          Get-ChildItem -Path dll -Recurse -Include *.dll | ForEach-Object { Write-Host $_.FullName }

      - name: Push DLLs to dll-artifacts branch
        shell: powershell
        run: |
          Write-Host 'üöÄ Pushing DLLs to dll-artifacts branch...'
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout -B dll-artifacts
          git add dll
          git commit -m "Add generated DLLs"
          git push -f origin dll-artifacts
          Write-Host '‚úÖ DLLs pushed to dll-artifacts branch.'

      - name: Upload DLL artifacts (optional backup)
        uses: actions/upload-artifact@v4
        with:
          name: compiled-dlls
          path: dll/
