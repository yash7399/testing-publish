name: Build and Publish DLLs

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build Website (publish)
        shell: pwsh
        run: |
          $source = "SMSInterface"
          $target = "website_publish"
          Write-Host "ðŸ”§ Building website from $source ..."
          mkdir $target -Force
          & "C:\Program Files (x86)\Microsoft SDKs\Windows\v10.0A\bin\NETFX 4.8 Tools\aspnet_compiler.exe" -v / -p $source $target
          Write-Host "âœ… Website precompiled successfully into $target"

      - name: Create target dlls folder inside SMSInterface
        shell: pwsh
        run: |
          $dllPath = "SMSInterface\dlls"
          if (Test-Path $dllPath) { Remove-Item -Recurse -Force $dllPath }
          New-Item -ItemType Directory -Force -Path $dllPath | Out-Null

      - name: Copy all generated DLLs into SMSInterface/dlls
        shell: pwsh
        run: |
          $sourceBin = "website_publish\bin"
          $dest = "SMSInterface\dlls"
          Get-ChildItem -Path $sourceBin -Filter *.dll | ForEach-Object {
            Copy-Item $_.FullName -Destination $dest -Force
          }
          Write-Host "âœ… Copied DLLs to $dest"

      - name: Show git status (debug)
        run: git status

      - name: Configure Git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create new branch and commit DLLs
        shell: pwsh
        run: |
          $branchName = "dll-publish-$(Get-Date -Format 'yyyyMMdd-HHmm')"
          git checkout -b $branchName
          git add SMSInterface/dlls
          git commit -m "Add compiled DLLs on $((Get-Date).ToString('yyyy-MM-dd HH:mm'))"
          git push origin $branchName
          Write-Host "âœ… Pushed DLLs to branch $branchName"

      - name: Print result
        run: echo "ðŸŽ‰ DLLs published successfully!"
