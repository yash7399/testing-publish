name: Build and Publish DLLs

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # Full history required for new branch creation

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Build Website (publish)
        run: |
          msbuild SMSInterface/SMSInterface.csproj /p:Configuration=Release /p:DeployOnBuild=true /p:OutputPath=publish

      - name: Create target dlls folder inside SMSInterface
        run: |
          New-Item -ItemType Directory -Force -Path SMSInterface/dlls

      - name: Copy all generated DLLs into SMSInterface/dlls
        shell: pwsh
        run: |
          $dest = "SMSInterface/dlls"

          # Ensure folder exists
          if (!(Test-Path $dest)) {
            New-Item -ItemType Directory -Force -Path $dest | Out-Null
          }

          # Clean old DLLs first
          Get-ChildItem -Path $dest -Filter *.dll -Recurse | Remove-Item -Force -ErrorAction SilentlyContinue

          # Copy new DLLs (excluding dlls folder itself)
          Get-ChildItem -Path . -Filter *.dll -Recurse | Where-Object {
            $_.FullName -notmatch [regex]::Escape($dest)
          } | ForEach-Object {
            Copy-Item -Path $_.FullName -Destination $dest -Force
          }

          Write-Host "✅ Copied DLLs to $dest"
          Get-ChildItem -Path $dest

      - name: Show git status (debug)
        run: git status

      - name: Configure Git user
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Create new branch and commit DLLs
        shell: pwsh
        run: |
          $branchName = "dlls-$(Get-Date -Format 'yyyyMMdd-HHmmss')"
          git checkout -b $branchName

          git add SMSInterface/dlls/*.dll
          git commit -m "Add latest DLLs from automated build"
          git push origin $branchName

          Write-Host "✅ New branch created and pushed: $branchName"

      - name: Upload DLLs as artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: built-dlls
          path: SMSInterface/dlls
